<h1>Appointments This Week</h1>
<% if (typeof messages === "function") { %>
  <div class="flash">
    <%- messages() %>
  </div>
<% } %>
<% if (errors && errors.length) { %>
  <ul class="notice" role="alert">
    <% errors.forEach(error => { %>
      <li><%= error.msg %></li>
    <% }) %>
  </ul>
<% } %>
<% if (!appts || !appts.length) { %>
  <p class="form-note">No appointments in this window.</p>
<% } else { %>
 <div class="table-wrap">
  <table class="table appt-table">
    <thead>
      <tr>
        <th class="col-date">Date</th>
        <th class="col-time">Time</th>
        <th class="col-customer">Customer</th>
        <th>Vehicle</th>
        <th>Status</th>
        <th class="col-actions">Actions</th>
      </tr>
    </thead>
    <tbody>
    <% appts.forEach(a => { 
         const d = new Date(a.appt_date);
         const dateStr = isNaN(d) ? a.appt_date 
           : d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
         const start = (a.appt_start || '').slice(0,5);
         const end = (a.appt_end || '').slice(0,5);
         const statusClass = `status--${a.appt_status}`;
    %>
      <tr>
        <td class="col-date" data-label="Date"><%= dateStr %></td>
        <td class="col-time" data-label="Time"><%= start %>-<%= end %></td>
        <td class="cell-customer" data-label="Customer">
          <strong><%= a.account_firstname %> <%= a.account_lastname %></strong>
          <span class="muted">(<%= a.account_email %>)</span>
        </td>
        <td class="cell-vehicle" data-label="Vehicle"><%= a.inv_year %> <%= a.inv_make %> <%= a.inv_model %></td>
        <td data-label="Status"><span class="status-pill <%= statusClass %>"><%= a.appt_status %></span></td>
        
        <td class="col-actions" data-label="Actions">
          <a class="btn"
            href="/appointment/<%= a.appt_id %>"
            aria-label="View details for <%= a.account_firstname %> <%= a.account_lastname %> â€” <%= a.inv_year %> <%= a.inv_make %> <%= a.inv_model %> on <%= dateStr %> from <%= start %> to <%= end %>">
            Details
            <span class="sr-only">
              for <%= a.account_firstname %> <%= a.account_lastname %>,
              <%= a.inv_year %> <%= a.inv_make %> <%= a.inv_model %>,
              <%= dateStr %>, <%= start %>&ndash;<%= end %>
            </span>
          </a>

          <% if (a.appt_status === 'Scheduled') { %>
            <form action="/appointment/staff/complete/<%= a.appt_id %>" method="post" style="display:inline">
              <button type="submit" class="btn"
                      aria-label="Mark appointment <%= a.appt_id %> as completed">
                Complete
              </button>
            </form>
            <form action="/appointment/staff/cancel/<%= a.appt_id %>" method="post" style="display:inline">
              <button type="submit" class="btn"
                      aria-label="Cancel appointment <%= a.appt_id %>">
                Cancel
              </button>
            </form>
          <% } %>
        </td>
      </tr>
    <% }) %>
    </tbody>
  </table>
</div>

<% } %>
